name: Auto-Route Deployment on PR Merge

on:
  pull_request:
    types: [closed]
    branches: [main]

jobs:
  deploy:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get list of changed files in the PR
        id: changes
        run: |
          echo "CHANGED_FILES<<EOF" >> $GITHUB_ENV
          git diff --name-only origin/main HEAD >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Determine Deployment Target
        id: target
        run: |
          DESTINATION=""
          SOURCE=""

          # datamaps
          if echo "${CHANGED_FILES}" | grep -q "^datamaps/"; then
            DESTINATION="/opt/fatack/ofsaa/bdf/config/datamaps"
            SOURCE="datamaps/"
          fi

          # customs
          if echo "${CHANGED_FILES}" | grep -q "^customs/"; then
            DESTINATION="/opt/fatack/ofsaa/bdf/config/customs"
            SOURCE="customs/"
          fi

          # config root
          if echo "${CHANGED_FILES}" | grep -q "^config/"; then
            DESTINATION="/opt/fatack/ofsaa/bdf/config"
            SOURCE="config/"
          fi

          if [ -z "$DESTINATION" ]; then
            echo "No deployment target found. Exiting."
            exit 1
          fi

          echo "SOURCE=$SOURCE" >> $GITHUB_ENV
          echo "DESTINATION=$DESTINATION" >> $GITHUB_ENV

          echo "Chosen SOURCE: $SOURCE"
          echo "Chosen DESTINATION: $DESTINATION"

      - name: Deploy via SSH
        uses: easingthemes/ssh-deploy@v4
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          REMOTE_HOST: ${{ secrets.SERVER_HOST }}
          REMOTE_USER: ${{ secrets.SERVER_USER }}
          ARGS: "-avzr --delete"
          SOURCE: ${{ env.SOURCE }}
          TARGET: ${{ env.DESTINATION }}
